{% extends 'junox/base.html' %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div class="bg-gradient-to-br from-indigo-600 to-blue-700 p-6 rounded-2xl shadow-xl border border-blue-400/20">
            <p class="text-blue-100 text-xs font-bold uppercase tracking-widest opacity-80 mb-1">Total Fleet</p>
            <div class="flex items-end justify-between">
                <h1 class="text-5xl font-black text-white leading-none">{{ stats.total_devices }}</h1>
                <span class="text-blue-200 text-xs font-medium">Nodes Managed</span>
            </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-lg flex flex-col justify-between">
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Operational</p>
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>
                <h3 class="text-4xl font-bold text-white">{{ stats.operational_count }}</h3>
            </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-lg flex flex-col justify-between">
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Attention Needed</p>
            <div class="flex items-center gap-3">
                <div
                    class="w-3 h-3 rounded-full {% if stats.failed_count > 0 %}bg-rose-500 animate-bounce{% else %}bg-slate-700{% endif %}">
                </div>
                <h3 class="text-4xl font-bold text-white">{{ stats.failed_count }}</h3>
            </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-lg flex flex-col justify-between">
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Discovery</p>
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-blue-400 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <h3 class="text-4xl font-bold text-white">{{ stats.pending_count }}</h3>
            </div>
        </div>
    </div>

    <h2 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Global Overview</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        {% for category, data in stats.global.items %}
        <div class="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg">
            <h3 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-4">
                Total by {{ category|title }}
            </h3>
            <div class="h-48 relative">
                <canvas id="chart-global-{{ category }}"></canvas>
            </div>
        </div>
        {% endfor %}
    </div>

    <h2 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">OS Distribution (Per Vendor)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for vendor, os_data in stats.os_by_vendor.items %}
        <div class="bg-slate-800 border border-slate-700 p-5 rounded-xl shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white font-bold text-lg capitalize">
                    {{ vendor }}
                </h3>
                <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">OS Versions</span>
            </div>
            <div class="h-56 relative w-full">
                <canvas id="chart-os-{{ vendor }}"></canvas>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<script>
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    // Specifically target the nested dictionaries from your updated backend response
    const globalStats = {{ stats.global| safe }};
    const vendorStats = {{ stats.os_by_vendor| safe }};

    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];

    function createChart(canvasId, labels, data, type = 'doughnut') {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        new Chart(ctx.getContext('2d'), {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#0f172a', // Matches Slate-900 for cutout effect
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#cbd5e1',
                            font: { size: 10 },
                            boxWidth: 10,
                            padding: 10
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value > 0 ? value : '',
                        anchor: 'center',
                        align: 'center',
                    }
                }
            }
        });
    }

    // Render Global Charts (Type, Model, Vendor)
    Object.keys(globalStats).forEach(key => {
        createChart(`chart-global-${key}`, Object.keys(globalStats[key]), Object.values(globalStats[key]), 'pie');
    });

    // Render Vendor-specific OS Charts
    Object.keys(vendorStats).forEach(vendor => {
        createChart(`chart-os-${vendor}`, Object.keys(vendorStats[vendor]), Object.values(vendorStats[vendor]), 'doughnut');
    });
</script>

{% endblock %}